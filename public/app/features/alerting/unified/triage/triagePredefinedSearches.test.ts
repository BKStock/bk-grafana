import { extractFilterObjects } from './scene/triageSavedSearchUtils';
import {
  TRIAGE_PREDEFINED_SEARCH_IDS,
  TRIAGE_PREDEFINED_SEARCH_ID_PREFIX,
  getTriagePredefinedSearches,
  isTriagePredefinedSearchId,
} from './triagePredefinedSearches';

describe('triagePredefinedSearches', () => {
  describe('getTriagePredefinedSearches()', () => {
    it('each search has stable id, name, isDefault false, and non-empty query', () => {
      for (const search of getTriagePredefinedSearches()) {
        expect(search.id).toMatch(new RegExp(`^${TRIAGE_PREDEFINED_SEARCH_ID_PREFIX}`));
        expect(typeof search.name).toBe('string');
        expect(search.name.length).toBeGreaterThan(0);
        expect(search.isDefault).toBe(false);
        expect(typeof search.query).toBe('string');
        expect(search.query.length).toBeGreaterThan(0);
      }
    });

    it('all predefined searches use default time range (15m from scene/utils)', () => {
      for (const search of getTriagePredefinedSearches()) {
        const params = new URLSearchParams(search.query);
        expect(params.get('from')).toBe('now-15m');
        expect(params.get('to')).toBe('now');
      }
    });

    it('first search has filter firing and groupBy folder and rule_group', () => {
      const first = getTriagePredefinedSearches()[0];
      const params = new URLSearchParams(first.query);
      expect(params.getAll('var-groupBy')).toEqual(['grafana_folder', 'rule_group']);
      const filters = extractFilterObjects(first.query);
      expect(filters).toHaveLength(1);
      expect(filters[0]).toMatchObject({ key: 'alertstate', value: 'firing' });
    });

    it('second search has filter firing only (no groupBy)', () => {
      const second = getTriagePredefinedSearches()[1];
      const params = new URLSearchParams(second.query);
      expect(params.getAll('var-groupBy')).toEqual([]);
      const filters = extractFilterObjects(second.query);
      expect(filters).toHaveLength(1);
      expect(filters[0]).toMatchObject({ key: 'alertstate', value: 'firing' });
    });

    it('third search has groupBy folder and rule_group only', () => {
      const third = getTriagePredefinedSearches()[2];
      const params = new URLSearchParams(third.query);
      expect(params.getAll('var-groupBy')).toEqual(['grafana_folder', 'rule_group']);
      expect(params.has('var-filters')).toBe(false);
    });

    it('fourth search has groupBy folder only', () => {
      const fourth = getTriagePredefinedSearches()[3];
      const params = new URLSearchParams(fourth.query);
      expect(params.getAll('var-groupBy')).toEqual(['grafana_folder']);
      expect(params.has('var-filters')).toBe(false);
    });
  });

  describe('TRIAGE_PREDEFINED_SEARCH_IDS', () => {
    it('contains all predefined search ids', () => {
      expect(TRIAGE_PREDEFINED_SEARCH_IDS.size).toBe(getTriagePredefinedSearches().length);
      for (const s of getTriagePredefinedSearches()) {
        expect(TRIAGE_PREDEFINED_SEARCH_IDS.has(s.id)).toBe(true);
      }
    });
  });

  describe('isTriagePredefinedSearchId', () => {
    it('returns true for predefined ids', () => {
      expect(isTriagePredefinedSearchId(`${TRIAGE_PREDEFINED_SEARCH_ID_PREFIX}folder-evalgroup`)).toBe(true);
      expect(isTriagePredefinedSearchId(`${TRIAGE_PREDEFINED_SEARCH_ID_PREFIX}folder-firing`)).toBe(true);
      expect(isTriagePredefinedSearchId(`${TRIAGE_PREDEFINED_SEARCH_ID_PREFIX}firing-only`)).toBe(true);
    });

    it('returns false for user-generated ids', () => {
      expect(isTriagePredefinedSearchId('abc-123')).toBe(false);
      expect(isTriagePredefinedSearchId('triage-predefined-x')).toBe(true); // prefix match
    });
  });
});
