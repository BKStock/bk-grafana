package notifier

import (
	"crypto/md5"
	"encoding/json"

	"github.com/grafana/alerting/definition"
	alertingModels "github.com/grafana/alerting/models"
	alertingNotify "github.com/grafana/alerting/notify"

	apimodels "github.com/grafana/grafana/pkg/services/ngalert/api/tooling/definitions"
	"github.com/grafana/grafana/pkg/services/ngalert/models"
)

// Silence-specific compat functions to convert between grafana/alerting and model types.

func GettableSilenceToSilence(s alertingNotify.GettableSilence) *models.Silence {
	sil := models.Silence(s)
	return &sil
}

func GettableSilencesToSilences(silences alertingNotify.GettableSilences) []*models.Silence {
	res := make([]*models.Silence, 0, len(silences))
	for _, sil := range silences {
		res = append(res, GettableSilenceToSilence(*sil))
	}
	return res
}

func SilenceToPostableSilence(s models.Silence) *alertingNotify.PostableSilence {
	var id string
	if s.ID != nil {
		id = *s.ID
	}
	return &alertingNotify.PostableSilence{
		ID:      id,
		Silence: s.Silence,
	}
}

func IntegrationToIntegrationConfig(i models.Integration) (alertingModels.IntegrationConfig, error) {
	raw, err := json.Marshal(i.Settings)
	if err != nil {
		return alertingModels.IntegrationConfig{}, err
	}
	return alertingModels.IntegrationConfig{
		UID:                   i.UID,
		Name:                  i.Name,
		Type:                  string(i.Config.Type()),
		DisableResolveMessage: i.DisableResolveMessage,
		Settings:              raw,
		SecureSettings:        i.SecureSettings,
	}, nil
}

func PostableAPIConfigToNotificationsConfiguration(c *apimodels.PostableUserConfig, limits alertingNotify.DynamicLimits) (alertingNotify.NotificationsConfiguration, error) {
	cfg := alertingNotify.NotificationsConfiguration{
		RoutingTree:       c.AlertmanagerConfig.Route.AsAMRoute(),
		InhibitRules:      c.AlertmanagerConfig.InhibitRules,
		MuteTimeIntervals: c.AlertmanagerConfig.MuteTimeIntervals,
		TimeIntervals:     c.AlertmanagerConfig.TimeIntervals,
		Templates:         alertingNotify.PostableAPITemplatesToTemplateDefinitions(c.GetMergedTemplateDefinitions()),
		Receivers:         alertingNotify.PostableAPIReceiversToAPIReceivers(c.AlertmanagerConfig.Receivers),
	}

	rawConfig, err := json.Marshal(cfg)
	if err != nil {
		return alertingNotify.NotificationsConfiguration{}, err
	}
	cfg.Limits = limits           // Leave out of hash.
	cfg.Raw = rawConfig           // Used in GetStatus.
	cfg.Hash = md5.Sum(rawConfig) // Used in the local alertmanager to determine if config changed and remote to determine the "Default" field.
	return cfg, nil
}

func NotificationsConfigurationToPostableAPIConfig(config alertingNotify.NotificationsConfiguration) apimodels.PostableApiAlertingConfig {
	return apimodels.PostableApiAlertingConfig{
		Config: apimodels.Config{
			Global:            nil, // Grafana does not have global.
			Route:             definition.AsGrafanaRoute(config.RoutingTree),
			InhibitRules:      config.InhibitRules,
			TimeIntervals:     config.TimeIntervals,
			MuteTimeIntervals: config.MuteTimeIntervals,
			Templates:         nil, // we do not use this.
		},
		Receivers: APIReceiversToPostableAPIReceivers(config.Receivers),
	}
}

func APIReceiversToPostableAPIReceivers(r []*alertingNotify.APIReceiver) []*definition.PostableApiReceiver {
	result := make([]*definition.PostableApiReceiver, 0, len(r))
	for _, receiver := range r {
		result = append(result, APIReceiverToPostableAPIReceiver(receiver))
	}
	return result
}

func APIReceiverToPostableAPIReceiver(r *alertingNotify.APIReceiver) *definition.PostableApiReceiver {
	receivers := make([]*definition.PostableGrafanaReceiver, 0, len(r.Integrations))
	for _, p := range r.Integrations {
		receivers = append(receivers, IntegrationConfigToPostableGrafanaReceiver(p))
	}

	return &definition.PostableApiReceiver{
		Receiver: r.ConfigReceiver,
		PostableGrafanaReceivers: definition.PostableGrafanaReceivers{
			GrafanaManagedReceivers: receivers,
		},
	}
}

func IntegrationConfigToPostableGrafanaReceiver(r *alertingModels.IntegrationConfig) *definition.PostableGrafanaReceiver {
	return &definition.PostableGrafanaReceiver{
		UID:                   r.UID,
		Name:                  r.Name,
		Type:                  r.Type,
		DisableResolveMessage: r.DisableResolveMessage,
		Settings:              definition.RawMessage(r.Settings),
		SecureSettings:        r.SecureSettings,
	}
}
